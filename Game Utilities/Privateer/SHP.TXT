Файл графики .SHP состоит из заголовка и набора спрайтов. При этом все тело
файла может быть сжато блочным методом, также используемым для CPS-файлов,
в этом случае в нем:
+0 DW длина файла-2
+2 DW 4
+4 DW размер результата раскрутки
+6 DW 0
+8 DW 0
+A ... сжатый образ файла
Спрайты состоят из заголовка и тела, которое также может быть сжато тем же
методом.
Заголовок файла устроен так:
+0 DW число листов в файле
+2 DD для каждого спрайта его смещение считая от +2; после всех смещений спрай-
      тов такое же смещение конца файла
+? ... тело файла
Заголовок спрайта устроен так:
+0 DW флаги типа:
      бит 0=1 - есть таблица перекодировки цвета
      бит 1=1 - тело спрайта не сжато
      бит 2=1 - в начале таблицы перекодировки стоит ее длина
+2 DB высота спрайта
+3 DW ширина спрайта
+5 DB пусто
+6 DW размер спрайта с заголовком в файле
+8 DW размер буфера для CPS-распаковки тела спрайта
+A DB если бит 2=1, то длина таблицы перекодировки и сама таблица следом за
      ней, причем сам байт длины в счет длины не входит;
      если бит 2=0, то просто таблица перекодировки длиной 10h байт;
      если бит 0=0, то само тело спрайта
+? DB тело спрайта

Несжатое тело спрайта устроено так:
если байт не равен 0, то это байт цвета (перекодируемый по таблице через XLAT
или нет); если же байт равен 0, то следующий за ним байт - это число байт
пропуска (прозрачных то есть).

Блоки упаковки устроены так же, как и в .CPS:
концевик:
+0 DB 80h , на нем вывод изображения прекращается
блок длинного повторенного копирования:
+0 DB 0FFh
+1 DW счетчик
+3 DW смещение источника в видеопамяти
блок заполнения:
+0 DB 0FEh
+1 DW счетчик
+3 DB цвет
блок среднего повторенного копирования:
+0 DB 11xxxxxx
+1 DW смещение источника в видеопамяти , по нему копируются (xxxxxx+3) точек
блок копирования:
+0 DB 10xxxxxx
+1 DB (xxxxxx) байт изображения, по нему они копируются на экран
блок короткого повторенного копирования:
+0 DB 0xxxyyyy
+1 DB 0ZTh , по нему (xxx+3) точек копируются из ($-0YZTh)
            ( $-текущее смещение, Y=yyyy)

Начальное смещение в буфере распаковки всегда 0.

Вот,собственно,и все...