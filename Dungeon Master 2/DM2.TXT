Файл ресурсов GRAPHICS.DAT игры DUNGEON MASTER 2 (32-битной версии) устроен так:
+0 DB 5 (тип файла?)
+1 DB 80h (сигнатура?)
+2 DW число ресурсов в файле+1
+4 DD размер неизвестно чего
+8 DW размер 1-го ресурса
+A ... так же для всех ресурсов
+? ... то самое "неизвестно что"
+? ... тело 1-го ресурса
Самих ресурсов в файле 5623 штуки, но большинство их имеет весьма малый размер.
Графические ресурсы подразделяются на 2 типа - 4-битные и 8-битные. Определенный
признак, позволяющий однозначно опознавать графические ресурсы, обнаружить не
удалось, так что остается только проверка на соответствие формату по начальным
байтам и размеру, которая иногда проходит и для ресурсов неграфических, которые
ошибочно определяются как 4-битные графические. Эти последние можно отличать и
отбрасывать при распаковке: должны быть использованы все байты тела ресурса -
ни байтом больше и ни байтом меньше.
4-битный ресурс устроен так:
+0 DW число столбцов (старшие 6 бит отбрасываются: AND 3FFh)
+2 DW число строк (старшие 6 бит отбрасываются)
+4 DB*3 таблица тетрад
+7 DB*? тело ресурса
+? DB*16 таблица перекодировки цвета (0..F->0..FF)
Ресурс имеет размер не менее 24 байт. Признаком этого типа ресурса является:
(w[+2] shr 10)<1Fh.
Тело ресурса этого типа сжато довольно кривым блочным методом - с RLE-сжатием и
неудачными потугами на LZ-сжатие - работающим не с байтами, а с тетрадами.
Выборка тетрад идет с младших адресов и _старших_ тетрад, и так же идет
индексация тетрад в таблице (индексы 0..5: DB 10,32,54).
Блоки сжатия устроены так:
блок табличного копирования точки:
DT 0xxx, xxx=0..5, по нему выводится точка (xxx)-го цвета (тетрады) из таблицы
блок копирования точки с предыдущей строки:
DT 0110, по нему копируется точка из той же позиции предыдущей строки
блок прямого копирования точки:
DT 0111
DT цвет, по нему выводится точка этого цвета
блок табличного заполнения строки:
DT 1xxx, xxx=0..5
DV N, по нему N точек заполняются (xxx)-м цветом
блок копирования строки с предыдущей строки:
DT 1110
DV N, по нему копируется N точек начиная с той же позиции предыдущей строки
блок прямого заполнения строки:
DT 1111
DT цвет
DV N, по нему N точек заполняются этим цветом
Здесь обозначение DT соответствует тетраде, а обозначение DV - числу переменной
длины. Последние устроены следующим образом:
либо DT xxxx, xxxx<1111b, N=X+2;
либо DT 1111 xxxx yyyy, XY<0FFh, N=XY+11h;
либо DT 1111 1111 1111 xxxx yyyy zzzz tttt, N=XYZT.
Распаковка заканчивается в момент, когда в выходной буфер помещено сколько нужно
байт (число столбцов*число строк). Исчерпание байт тела ресурса до этого момента
служит признаком неверно распознанного как графический ресурса. Распакованное
тело ресурса - простой битмап, расположенный по строкам.
8-битный ресурс устроен так:
+0 DW число столбцов (старшие 6 бит отбрасываются: AND 3FFh)
+2 DW число строк (старшие 6 бит отбрасываются)
+4 DW ? (не используется)
+6 DB тип сжатия
+7 DB ? (не используется)
+8 DB*? тело ресурса
Ресурс имеет размер не менее 10 байт. Признаком этого типа ресурса является:
(w[+2] shr 10)=1Fh.
Тип сжатия может быть 1, 2 или 3; ресурсы типа 1 в файле не встречаются.
Тело ресурса типа 2 распаковывается по следующей схеме LZ-метода:
извлекается флаговый байт, каждый бит которого означает: для 1, извлечь оче-
редной байт и поместить его в выходное изображение; для 0, извлечь слово,
трактуемое как XYZTh и скопировать в выходное изображение (T+3) байт начиная со
смещения ($-0XYZh) в выходном буфере (здесь $=текущее смещение в нем); по
исчерпании битов флагового байта, извлечь новый флаговый байт. Раскодировка
ведется до конца тела ресурса.
Тело ресурса типа 3 распаковывается так же, за исключением того, что слово
"смещение-счетчик" (XYZT) разделяется не на 12 бит смещения и 4 бита счетчика,
а на 11 бит смещения и 5 бит счетчика.
Распакованное тело ресурса - простой битмап, расположенный по строкам.
Прозрачный цвет для картинок неким сложным образом извлекается из "неизвестно
чего" с использованием еще каких-то данных; выяснять и воспроизводить этот
процесс у меня нет желания, так как можно просто определять этот цвет на глаз.

Вот, собственно, и все...