Файл графики .ACE игры REALMS OF ARKANIA 2: STAR TRAIL состоит из заголовка,
набора заголовков последовательностей,набора картинок и палитры.Картинки состоят
из заголовка и тела.
Заголовок файла устроен так:
+0 DB*4 'ACE',0 - сигнатура
+4 DW 1
+6 DB число последовательностей в файле
+7 DB мера задержки кадров (=1,если 0) (время в тиках таймера?)
+8 ... заголовки последовательностей
Заголовки последовательностей имеют различную структуру в случае одной последо-
вательности в файле и в случае нескольких.
Заголовок единственной последовательности устроен так:
+0 DW ширина окна
+2 DW высота окна
+4 DB число картинок в последовательности
+5 DB флаг циклической анимации (циклическая,если <>0)
+6 ... 1-я картинка последовательности
Заголовок не-единственной последовательности устроен так:
+00 DD смещение в файле 1-й картинки последовательности
+04 DW идентификатор последовательности (уникальный ее номер в файле)
+06 DW ширина окна
+08 DW высота окна
+0A DW собственный сдвиг последовательности слева (слово со знаком)
+0C DW собственный сдвиг последовательности сверху (-"-)
+0E DB число картинок в последовательности (бывает и 0)
+0F DB флаг циклической анимации (циклическая,если <>0)
+10 ... следующий заголовок
Заголовок картинки устроен так:
+0 DD размер тела картинки
+4 DW собственный сдвиг слева
+6 DW собственный сдвиг сверху
+8 DW ширина картинки
+A DW высота картинки
+C DB тип сжатия - может быть 1,2 или 50; при другом значении тело не сжато
+D DB неизвестно что (нигде не используется) (?) (обычно 0)
+E ... тело картинки
Тело картинки имеет различный тип компрессии (если имеет) в зависимости от
указанного в ее заголовке типа сжатия,а именно:
-тип 1: тело сжато RLE-методом:
        блок заполнения: DB 7Fh / DB счетчик / DB цвет;
        иначе байт просто копируется на экран.
-тип 2: тело сжато блочным RLE-методом:
        блок копирования: DB b<80h / DB (1-b) байт изображения;
        блок заполнения: DB b>=80h / DB цвет; этим цветом закрашиваются (b+1)
                         точек.
При этих методах раскодировка прекращается, когда в выходной буфер помещено
достаточно (то есть ширина*высота) байт.
-тип 50: тело сжато LZSS-методом в весьма идиотской реализации, для использова-
         ния в программах почти непригодной. А именно:
         Тело файла используется как массив битов, причем выборка их идет
         начиная с младших битов и со _старших_ адресов. Выбранные биты
         вдвигаются в результат _справа_ в порядке выборки, то есть в результате
         они оказываются расположенными в порядке, _обратном_ расположению в
         теле файла. LZSS-раскодировка идет по следующей схеме: пусть @=размер
         входного файла, #-смещение в выходном буфере, входной и выходной буфер
         начинаются со смещения 0. Тогда # := (по байтам) 0:[@-3]:[@-2]:[@-1],
         массив битов начинается с [@-5], причем байт [@-4] содержит, сколько
         первых битов следует пропустить. После чего в цикле читаются из
         входного потока и обрабатываются следующие битовые последовательности:
         - либо 0 11 11 .... 11 ?? ...                 , либо 1
                 └──┴──┴┬───┴──┘├┘└───┴─┐
                     N штук     └M<>11b байты данных
           Это блок извлечения из входного потока (3*N+M) байт данных, причем
           _перед_ помещением каждого байта в выходной поток, # _уменьшается_
           на 1. После этого блока выполняется проверка, заполнен ли выходной
           буфер. Этого блока может не быть (когда 1 вместо 0 в его начале).
         - после чего либо 11 k ... 111 111 .... 111 ???  , либо ?? ...
                                └┬┘└───┴───┴┬───┴───┘├─┘         ├┘ └─┴─┐
                                 СNT бит    N штук   └M<>111b    X<>11b └СNT бит
           Это блок копирования строки байт. В его первом варианте, если бит
           k=0, то CNT:=7, иначе CNT:=байт по смещению 7 во входном буфер; длина
           копируемой строки равна (7*N+M+5) байт. Во втором варианте, CNT:=байт
           по смещению (4+X) во входном буфере, а длина равна (X+2). В обеих
           вариантах, "CNT бит" образуют словное смещение D, и байты извлекаются
           со смещения (#+D) в выходном буфере, затем # _уменьшается_ на 1, и
           только затем байт помещается по смещению #.
           После этого блока выполняется проверка, заполнен ли выходной буфер.
           Если нет, то цикл повторяется.
Раскодировка прекращается в момент заполнения выходного буфера (когда смещение #
приняло значение 0).
Следует еще упомянуть, что при типе сжатия 50, в теле картинки по смещению 0
находится двойное слово - размер этого тела.
Палитра, имеющая размер 300h байт, расположена в самом конце файла.
Следует заметить, что иногда картинки используют некоторые цвета из предшест-
вующей палитры или вообще другую палитру.

Только и всего...